name: CI

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    permissions:
      contents: read

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24.11.1

      - name: Prepare for CI
        run: npm ci
      - name: Test standard build (not for integration testing)
        run: npm run build:main
      - name: Run tests (will rebuild for integration testing)
        run: xvfb-run npm run test --if-present

  windows-build:
    permissions:
      contents: write
      actions: write
      checks: write

    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    environment: release

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24.11.1

      - name: Prepare for CI
        run: npm ci


      - name: Get package version
        id: package_version
        shell: pwsh
        run: |
          $VERSION = node -p "require('./package.json').version"
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT

      - name: Verify tag matches version
        shell: pwsh
        run: |
          $TagVersion = "${{ github.ref_name }}".TrimStart('v')
          $PackageVersion = "${{ steps.package_version.outputs.version }}"
          if ($TagVersion -ne $PackageVersion) {
            Write-Error "Tag version ($TagVersion) does not match package.json version ($PackageVersion)"
            exit 1
          }

      - name: Build the Windows installer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build

        
      - name: Generate release notes
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace("refs/tags/", "");
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
            });

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: (await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag,
              })).data.id,
              body: data.body,
            });